name: IBM Cloud Auto deploy 
 
on: 
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '00 14 * * ?'

jobs:
  ibm20200620:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Init
      run: |
        pwd
        chmod -R 777 ./IBM_Cloud_CLI/
    - name: Login IBM Cloud
      env:
        IBM_ACCOUNT: ${{ secrets.IBM_ACCOUNT3 }}
        REGION_NUM: ${{ secrets.REGION_NUM3 }}
      run: |
        pwd
        ./IBM_Cloud_CLI/ibmcloud login <<EOF
        $IBM_ACCOUNT
        $REGION_NUM
        no
        EOF
    - name: deploy
      env:
        IBM_APP_NAME: ${{ secrets.IBM_APP_NAME3 }}
        IBM_UUID: ${{ secrets.UUID3 }}
        IBM_PATH: ${{ secrets.PATH3 }}
      run: |
        pwd
        rm -rf v2ray-cloudfoundry
		      mikdir v2ray-cloudfoundry
		      cd v2ray-cloudfoundry
		
        cat > manifest-ibm.yml << EOF
        ---
        applications:
        - path: .
          name: $IBM_APP_NAME
          random-route: true
          memory: 256M
          buildpacks:
          - binary_buildpack
         EOF
		
         mikdir v2ray
         cd v2ray
         wget -q https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-64.zip
         unzip -o v2ray-linux-64.zip "v2ray" "v2ctl" "geosite.dat" "geoip.dat" 
         rm -rf v2ray-linux-64.zip
         chmod 700 v2ray v2ctl

         cat > config.json << EOF
         {
           "inbounds": [
             {
               "port": 8080,
               "protocol": "vmess",
               "settings": {
                 "clients": [
                   {
                     "id": "$IBM_UUID",
                     "alterId": 64
                   }
                 ]
               },
               "streamSettings": {
                 "network":"ws",
                 "wsSettings": {
                 "path": "$IBM_PATH"
               }
             }
           ],
           "outbounds": [
             {
               "protocol": "freedom",
               "settings": {}
             }
           ]
         }
         EOF

    - name: Target IBM Cloud
      env:
       IBM_APP_NAME: ${{ secrets.IBM_APP_NAME3 }}      
       RESOURSE_ID: ${{ secrets.RESOURSE_ID3 }}
      run: |
        pwd
        #./IBM_Cloud_CLI/ibmcloud target -r eu-gb
        ./IBM_Cloud_CLI/ibmcloud target -g "$RESOURSE_ID"
        ./IBM_Cloud_CLI/ibmcloud target --cf
        ./IBM_Cloud_CLI/ibmcloud cf install
        ./IBM_Cloud_CLI/ibmcloud cf push "$IBM_APP_NAME" -f v2ray-cloudfoundry/manifest.yml
        
        



















